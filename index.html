<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="icon" href="data:," />
    <title>WaveRoll - MIDI Parser & Player Demo</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
        background: #f5f5f5;
      }
      .demo-section {
        background: white;
        padding: 20px;
        margin: 20px 0;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }
      .output {
        background: #f8f9fa;
        padding: 15px;
        border-left: 4px solid #007acc;
        margin: 10px 0;
        font-family: "Courier New", monospace;
        font-size: 12px;
        white-space: pre-wrap;
        max-height: 300px;
        overflow-y: auto;
      }
      .error {
        background: #fff5f5;
        border-left-color: #e53e3e;
        color: #e53e3e;
      }
      .success {
        background: #f0fff4;
        border-left-color: #38a169;
        color: #38a169;
      }
      button {
        background: #007acc;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 4px;
        cursor: pointer;
        margin: 5px;
      }
      button:hover {
        background: #005999;
      }
      button:disabled {
        background: #ccc;
        cursor: not-allowed;
      }
      input[type="text"],
      input[type="file"] {
        padding: 8px;
        margin: 5px;
        border: 1px solid #ddd;
        border-radius: 4px;
        width: 300px;
      }
      .loading {
        color: #007acc;
        font-style: italic;
      }
      .stats {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 10px;
        margin: 10px 0;
      }
      .stat-item {
        background: #e8f4f8;
        padding: 10px;
        border-radius: 4px;
      }
      .stat-label {
        font-weight: bold;
        color: #005999;
      }
      .player-container {
        background: #f8f9fa;
        padding: 20px;
        border-radius: 8px;
        margin: 15px 0;
        border: 2px dashed #007acc;
        min-height: 100px;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
      }
      .player-container.has-player {
        border-style: solid;
        background: white;
      }
      .wave-roll-player {
        width: 100%;
        margin-bottom: 10px;
      }
      .wave-roll-player-visualizer {
        width: 100%;
        border: 1px solid #ddd;
        border-radius: 4px;
      }
      .license-info {
        background: #f0f8ff;
        border: 1px solid #b8daff;
        padding: 15px;
        border-radius: 4px;
        margin: 10px 0;
        font-size: 12px;
      }
      .tabs {
        display: flex;
        margin-bottom: 20px;
      }
      .tab {
        padding: 10px 20px;
        background: #e9ecef;
        border: none;
        cursor: pointer;
        margin-right: 5px;
        border-radius: 4px 4px 0 0;
      }
      .tab.active {
        background: #007acc;
        color: white;
      }
      .tab-content {
        display: none;
      }
      .tab-content.active {
        display: block;
      }
    </style>
  </head>
  <body>
    <h1>WaveRoll - MIDI Parser & Player Demo</h1>
    <p>
      This demo showcases the complete WaveRoll library: MIDI parsing, data
      extraction, and interactive playback with piano-roll visualization.
    </p>

    <div class="license-info">
      <strong>License Information:</strong><br />
      • <strong>@tonejs/midi</strong> - MIT License<br />
      • <strong>html-midi-player</strong> - BSD-2-Clause License (Copyright
      notice retained in distribution)<br />
      • <strong>pixi.js</strong> - MIT License<br />
      • <strong>d3-scale</strong> - ISC License<br />
      • <strong>tone</strong> - MIT License
    </div>

    <div class="demo-section">
      <h2>Load MIDI File</h2>
      <div class="tabs">
        <button class="tab active" onclick="switchTab('file')">
          File Upload
        </button>
        <button class="tab" onclick="switchTab('url')">URL</button>
      </div>

      <div id="file-tab" class="tab-content active">
        <input type="file" id="fileInput" accept=".mid,.midi" />
        <button onclick="loadFromFile()" id="fileLoadBtn">
          Load & Parse MIDI File
        </button>
      </div>

      <div id="url-tab" class="tab-content">
        <input
          type="text"
          id="urlInput"
          placeholder="Enter MIDI file URL"
          value=""
        />
        <button onclick="loadFromUrl()" id="urlLoadBtn">Load from URL</button>
      </div>

      <div class="output" id="loadOutput">
        Select a MIDI file or enter a URL to get started...
      </div>
    </div>

    <div class="demo-section">
      <h2>Synchronized Audio Player + Piano Roll</h2>
      <p>
        Complete audio playback with synchronized PixiJS piano roll visualizer
        (powered by Tone.js)
      </p>
      <div
        class="player-container"
        id="syncPlayerContainer"
        style="height: 500px"
      >
        <div>Load a MIDI file above to see the synchronized player here</div>
      </div>
      <div style="margin: 10px 0">
        <button onclick="createSyncPlayer()" id="createSyncPlayerBtn" disabled>
          Create Synchronized Player
        </button>
        <button onclick="clearSyncPlayer()" id="clearSyncPlayerBtn" disabled>
          Clear Synchronized Player
        </button>
      </div>
      <div style="margin: 10px 0; font-size: 12px; color: #666">
        <strong>Features:</strong> Audio playback, visual sync ≤16ms drift,
        play/pause/restart/repeat, volume/tempo controls
      </div>
    </div>

    <div class="demo-section">
      <h2>Interactive MIDI Player</h2>
      <p>
        Piano-roll visualization with playback controls (powered by
        html-midi-player)
      </p>
      <div class="player-container" id="playerContainer">
        <div>Load a MIDI file above to see the interactive player here</div>
      </div>
      <button onclick="createPlayer()" id="createPlayerBtn" disabled>
        Create Player
      </button>
      <button onclick="clearPlayer()" id="clearPlayerBtn" disabled>
        Clear Player
      </button>
    </div>

    <div class="demo-section">
      <h2>PixiJS Piano Roll Visualizer</h2>
      <p>
        High-performance canvas-based piano roll with zoom, pan, and playback
        synchronization
      </p>
      <div
        class="player-container"
        id="pianoRollContainer"
        style="height: 400px"
      >
        <div>Load a MIDI file above to see the PixiJS piano roll here</div>
      </div>
      <div style="margin: 10px 0">
        <button
          onclick="createPianoRollPlayer()"
          id="createPianoRollBtn"
          disabled
        >
          Create PixiJS Piano Roll
        </button>
        <button onclick="clearPianoRoll()" id="clearPianoRollBtn" disabled>
          Clear Piano Roll
        </button>
        <button onclick="resetPianoRollView()" id="resetViewBtn" disabled>
          Reset View
        </button>
      </div>
      <div style="margin: 10px 0; font-size: 12px; color: #666">
        <strong>Controls:</strong> Mouse wheel = zoom time, Ctrl+wheel = zoom
        pitch, Drag = pan
      </div>
    </div>

    <div class="demo-section">
      <h2>Parsed Data Summary</h2>
      <div class="stats" id="statsContainer">
        <div class="stat-item">
          <div class="stat-label">Status</div>
          <div id="statusValue">No file loaded yet</div>
        </div>
      </div>
    </div>

    <div class="demo-section">
      <h2>Sample Notes Data</h2>
      <div class="output" id="notesOutput">
        Load a MIDI file to see note data...
      </div>
    </div>

    <script>
      // Intercept fetch to track JSON parsing errors
      (function () {
        const originalFetch = window.fetch;
        window.fetch = function (...args) {
          const url = args[0];
          // console.log("Fetch request:", url);

          return originalFetch
            .apply(this, args)
            .then((response) => {
              // console.log(`Fetch response for ${url}:`, {
              //   status: response.status,
              //   statusText: response.statusText,
              //   headers: Object.fromEntries(response.headers.entries()),
              //   url: response.url,
              // });

              // Clone the response to read it without consuming
              const clonedResponse = response.clone();

              // Check if it's a JSON response that might fail
              const contentType = response.headers.get("content-type");
              if (
                response.ok &&
                contentType &&
                (contentType.includes("json") ||
                  contentType.includes("javascript"))
              ) {
                clonedResponse.text().then((text) => {
                  try {
                    JSON.parse(text);
                  } catch (e) {
                    console.error(`JSON parse error for ${url}:`, e);
                    console.error(
                      "Response text preview:",
                      text.substring(0, 200)
                    );
                  }
                });
              }

              return response;
            })
            .catch((error) => {
              console.error(`Fetch error for ${url}:`, error);
              throw error;
            });
        };
      })();
    </script>

    <script type="module">
      import {
        parseMidi,
        createMidiPlayer,
        loadPlayerComponents,
        isPlayerAvailable,
        arrayBufferToDataUrl,
        debugPlayerState,
        createPianoRoll,
        createPlayerDemo,
      } from "/src/index.ts";

      let currentParsedData = null;
      let currentArrayBuffer = null;
      let pianoRollInstance = null;
      let syncPlayerInstance = null;

      // Initialize player components
      async function initializePlayer() {
        try {
          console.log("Loading MIDI player components...");
          await loadPlayerComponents();
          console.log("MIDI player components loaded");

          // Add user interaction prompt
          const playerContainer = document.getElementById("playerContainer");
          if (
            playerContainer &&
            !playerContainer.classList.contains("has-player")
          ) {
            playerContainer.innerHTML = `
                        <div style="text-align: center; padding: 20px; color: #666;">
                            <p>Load a MIDI file above to see the interactive player here</p>
                        </div>
                    `;
          }
        } catch (error) {
          console.error("Failed to load player components:", error);
          const playerContainer = document.getElementById("playerContainer");
          if (playerContainer) {
            playerContainer.innerHTML = `
                        <div style="text-align: center; padding: 20px; color: #e53e3e;">
                            Player components failed to load: ${error.message}
                        </div>
                    `;
          }
        }
      }

      // Tab switching
      window.switchTab = function (tabName) {
        // Update tab buttons
        document
          .querySelectorAll(".tab")
          .forEach((tab) => tab.classList.remove("active"));
        document
          .querySelector(`button[onclick="switchTab('${tabName}')"]`)
          .classList.add("active");

        // Update tab content
        document
          .querySelectorAll(".tab-content")
          .forEach((content) => content.classList.remove("active"));
        document.getElementById(`${tabName}-tab`).classList.add("active");
      };

      // Load MIDI from file
      window.loadFromFile = async function () {
        const fileInput = document.getElementById("fileInput");
        const output = document.getElementById("loadOutput");
        const btn = document.getElementById("fileLoadBtn");

        if (!fileInput.files || fileInput.files.length === 0) {
          output.textContent = "Please select a file first.";
          output.className = "output error";
          return;
        }

        const file = fileInput.files[0];
        await processFile(file, output, btn);
      };

      // Load MIDI from URL
      window.loadFromUrl = async function () {
        const urlInput = document.getElementById("urlInput");
        const output = document.getElementById("loadOutput");
        const btn = document.getElementById("urlLoadBtn");

        const url = urlInput.value.trim();
        if (!url) {
          output.textContent = "Please enter a URL first.";
          output.className = "output error";
          return;
        }

        await processFile(url, output, btn);
      };

      // Process MIDI file (common logic)
      async function processFile(input, output, btn) {
        btn.disabled = true;
        output.textContent = "Loading and parsing MIDI file...";
        output.className = "output loading";

        try {
          // Parse the MIDI file (this already loads the data internally)
          const result = await parseMidi(input);
          currentParsedData = result;

          // Get the raw ArrayBuffer for the player
          // We need to reload the data since parseMidi doesn't return the raw ArrayBuffer
          if (typeof input === "string") {
            try {
              const response = await fetch(input);
              if (!response.ok) {
                throw new Error(
                  `Failed to fetch: ${response.status} ${response.statusText}`
                );
              }
              currentArrayBuffer = await response.arrayBuffer();
            } catch (fetchError) {
              console.warn("Failed to fetch raw data for player:", fetchError);
              // If we can't fetch for the player, we can still show the parsed data
              currentArrayBuffer = null;
            }
          } else {
            // For File objects, read as ArrayBuffer
            try {
              currentArrayBuffer = await input.arrayBuffer();
            } catch (readError) {
              console.warn(
                "Failed to read file as ArrayBuffer for player:",
                readError
              );
              currentArrayBuffer = null;
            }
          }

          // Update UI
          output.textContent = "MIDI file loaded and parsed successfully!";
          output.className = "output success";

          updateStats(result);
          displaySampleNotes(result);

          // Enable player creation only if we have the raw data
          const createPlayerBtn = document.getElementById("createPlayerBtn");
          const container = document.getElementById("playerContainer");
          const existingPlayer = container.querySelector("midi-player");

          if (currentArrayBuffer) {
            createPlayerBtn.disabled = false;
            createPlayerBtn.textContent = existingPlayer
              ? "Update Player"
              : "Create Interactive Player";
          } else {
            createPlayerBtn.disabled = true;
            createPlayerBtn.textContent = "Player unavailable (no raw data)";
          }

          // Enable piano roll creation if we have parsed data
          const createPianoRollBtn =
            document.getElementById("createPianoRollBtn");
          if (currentParsedData) {
            createPianoRollBtn.disabled = false;
            createPianoRollBtn.textContent = pianoRollInstance
              ? "Update Piano Roll"
              : "Create PixiJS Piano Roll";
          } else {
            createPianoRollBtn.disabled = true;
            createPianoRollBtn.textContent = "Piano Roll unavailable";
          }

          // Enable synchronized player creation if we have parsed data
          const createSyncPlayerBtn = document.getElementById(
            "createSyncPlayerBtn"
          );
          if (currentParsedData) {
            createSyncPlayerBtn.disabled = false;
            createSyncPlayerBtn.textContent = syncPlayerInstance
              ? "Update Synchronized Player"
              : "Create Synchronized Player";
          } else {
            createSyncPlayerBtn.disabled = true;
            createSyncPlayerBtn.textContent = "Synchronized Player unavailable";
          }
        } catch (error) {
          output.textContent = `Error: ${error.message}`;
          output.className = "output error";
          currentParsedData = null;
          currentArrayBuffer = null;
          document.getElementById("createPlayerBtn").disabled = true;
        } finally {
          btn.disabled = false;
        }
      }

      // Create MIDI player
      window.createPlayer = async function () {
        if (!currentArrayBuffer) {
          alert("Please load a MIDI file first");
          return;
        }

        const container = document.getElementById("playerContainer");
        const btn = document.getElementById("createPlayerBtn");

        btn.disabled = true;

        // Check if player already exists to show appropriate message
        const existingPlayer = container.querySelector("midi-player");
        if (existingPlayer) {
          container.innerHTML = "<div>Updating player with new MIDI...</div>";
        } else {
          container.innerHTML = "<div>Creating player...</div>";
        }

        try {
          await createMidiPlayer(container, currentArrayBuffer, {
            showVisualizer: true,
            soundFont: true,
            height: "300px",
          });

          container.classList.add("has-player");
          document.getElementById("clearPlayerBtn").disabled = false;

          // Only add notice and debug button if they don't exist (avoid duplicates)
          if (!container.querySelector(".user-notice")) {
            // Add user interaction notice
            const notice = document.createElement("div");
            notice.className = "user-notice";
            notice.style.cssText =
              "text-align: center; padding: 10px; background: #f0f9ff; border-radius: 6px; margin-bottom: 10px; font-size: 14px; color: #0369a1;";
            notice.innerHTML = "Click the play button to start audio playback";
            container.insertBefore(notice, container.firstChild);
          }

          // Add debug information
          const debugInfo = debugPlayerState(container);
          console.log("Player debug info:", debugInfo);

          // Only add debug button if it doesn't exist
          if (!container.querySelector(".debug-btn")) {
            const debugBtn = document.createElement("button");
            debugBtn.className = "debug-btn";
            debugBtn.textContent = "Debug Player State";
            debugBtn.style.cssText =
              "margin: 5px; background: #6b7280; font-size: 12px; padding: 5px 10px;";
            debugBtn.onclick = () => {
              const state = debugPlayerState(container);
              console.table(state);
              alert(`Debug Info:\n${JSON.stringify(state, null, 2)}`);
            };
            container.appendChild(debugBtn);
          }

          // Update button text to reflect what happened
          btn.textContent = existingPlayer
            ? "Update Player"
            : "Create Interactive Player";
        } catch (error) {
          container.innerHTML = `<div style="color: #e53e3e;">Failed to create player: ${error.message}</div>`;
          console.error("Player creation error:", error);
        } finally {
          btn.disabled = false;
        }
      };

      // Clear player
      window.clearPlayer = function () {
        const container = document.getElementById("playerContainer");
        container.innerHTML =
          "<div>Load a MIDI file above to see the interactive player here</div>";
        container.classList.remove("has-player");
        document.getElementById("clearPlayerBtn").disabled = true;
        if (currentArrayBuffer) {
          document.getElementById("createPlayerBtn").disabled = false;
        }
      };

      // Create PixiJS Piano Roll
      window.createPianoRollPlayer = async function () {
        if (!currentParsedData) {
          alert("Please load a MIDI file first");
          return;
        }

        const container = document.getElementById("pianoRollContainer");
        const btn = document.getElementById("createPianoRollBtn");

        btn.disabled = true;

        try {
          if (pianoRollInstance) {
            console.log("Updating existing piano roll with new data");
            pianoRollInstance.setNotes(currentParsedData.notes);
          } else {
            console.log("Creating new PixiJS piano roll");

            pianoRollInstance = await createPianoRoll(
              container,
              currentParsedData.notes,
              {
                width: container.clientWidth || 800,
                height: 350,
                backgroundColor: 0xffffff,
                noteColor: 0x4285f4,
                playheadColor: 0xff4444,
                showPianoKeys: true,
                noteRange: { min: 21, max: 108 },
              }
            );
          }

          container.classList.add("has-player");
          document.getElementById("clearPianoRollBtn").disabled = false;
          document.getElementById("resetViewBtn").disabled = false;

          btn.textContent = "Update Piano Roll";
        } catch (error) {
          container.innerHTML = `<div style="color: #e53e3e;">Failed to create piano roll: ${error.message}</div>`;
          console.error("Piano roll creation error:", error);
        } finally {
          btn.disabled = false;
        }
      };

      // Clear piano roll
      window.clearPianoRoll = function () {
        if (pianoRollInstance) {
          pianoRollInstance.destroy();
          pianoRollInstance = null;
        }

        const container = document.getElementById("pianoRollContainer");
        container.innerHTML =
          "<div>Load a MIDI file above to see the PixiJS piano roll here</div>";
        container.classList.remove("has-player");
        document.getElementById("clearPianoRollBtn").disabled = true;
        document.getElementById("resetViewBtn").disabled = true;

        if (currentParsedData) {
          document.getElementById("createPianoRollBtn").disabled = false;
          document.getElementById("createPianoRollBtn").textContent =
            "Create PixiJS Piano Roll";
        }
      };

      // Reset piano roll view
      window.resetPianoRollView = function () {
        if (pianoRollInstance) {
          pianoRollInstance.resetView();
        }
      };

      // Create Synchronized Player
      window.createSyncPlayer = async function () {
        if (!currentParsedData) {
          alert("Please load a MIDI file first");
          return;
        }

        const container = document.getElementById("syncPlayerContainer");
        const btn = document.getElementById("createSyncPlayerBtn");

        btn.disabled = true;

        try {
          if (syncPlayerInstance) {
            console.log("Cleaning up existing synchronized player");
            syncPlayerInstance.destroy();
          }

          console.log("Creating new synchronized audio player + piano roll");

          // Extract initial tempo from MIDI data
          const initialTempo =
            currentParsedData.header.tempos &&
            currentParsedData.header.tempos.length > 0
              ? currentParsedData.header.tempos[0].bpm
              : 120; // fallback to 120 if no tempo events

          console.log(`Using initial tempo from MIDI: ${initialTempo} BPM`);

          syncPlayerInstance = await createPlayerDemo(
            container,
            currentParsedData.notes,
            {
              player: {
                tempo: initialTempo,
                volume: 0.7,
                repeat: false,
              },
              pianoRoll: {
                width: container.clientWidth || 800,
                height: 380,
                backgroundColor: 0xffffff,
                noteColor: 0x4285f4,
                playheadColor: 0xff4444,
                showPianoKeys: true,
                noteRange: { min: 21, max: 108 },
              },
              showTimeDisplay: true,
              showVolumeControl: true,
              showTempoControl: true,
            }
          );

          container.classList.add("has-player");
          document.getElementById("clearSyncPlayerBtn").disabled = false;

          btn.textContent = "Update Synchronized Player";
        } catch (error) {
          container.innerHTML = `<div style="color: #e53e3e;">Failed to create synchronized player: ${error.message}</div>`;
          console.error("Synchronized player creation error:", error);
        } finally {
          btn.disabled = false;
        }
      };

      // Clear synchronized player
      window.clearSyncPlayer = function () {
        if (syncPlayerInstance) {
          syncPlayerInstance.destroy();
          syncPlayerInstance = null;
        }

        const container = document.getElementById("syncPlayerContainer");
        container.innerHTML =
          "<div>Load a MIDI file above to see the synchronized player here</div>";
        container.classList.remove("has-player");
        document.getElementById("clearSyncPlayerBtn").disabled = true;

        if (currentParsedData) {
          document.getElementById("createSyncPlayerBtn").disabled = false;
          document.getElementById("createSyncPlayerBtn").textContent =
            "Create Synchronized Player";
        }
      };

      function updateStats(data) {
        const container = document.getElementById("statsContainer");
        container.innerHTML = `
                <div class="stat-item">
                    <div class="stat-label">Status</div>
                    <div>Successfully loaded</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">Song Name</div>
                    <div>${data.header.name}</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">Duration</div>
                    <div>${data.duration.toFixed(2)} seconds</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">Track Name</div>
                    <div>${data.track.name}</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">MIDI Channel</div>
                    <div>${data.track.channel}</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">Total Notes</div>
                    <div>${data.notes.length}</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">PPQ</div>
                    <div>${data.header.PPQ}</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">Tempo Events</div>
                    <div>${data.header.tempos.length}</div>
                </div>
            `;
      }

      function displaySampleNotes(data) {
        const output = document.getElementById("notesOutput");
        const sampleSize = Math.min(10, data.notes.length);
        const sampleNotes = data.notes.slice(0, sampleSize);

        let noteText = `Showing first ${sampleSize} of ${data.notes.length} notes:\n\n`;
        sampleNotes.forEach((note, index) => {
          noteText += `${index + 1}. ${note.name} (MIDI ${note.midi})\n`;
          noteText += `   Time: ${note.time.toFixed(3)}s, Duration: ${note.duration.toFixed(3)}s\n`;
          noteText += `   Velocity: ${note.velocity.toFixed(3)}, Pitch: ${note.pitch}, Octave: ${note.octave}\n\n`;
        });

        output.textContent = noteText;
        output.className = "output";
      }

      // Add global error handler to catch JSON parsing errors
      window.addEventListener("error", function (event) {
        console.error("Global error detected:", {
          message: event.error?.message || event.message,
          filename: event.filename,
          lineno: event.lineno,
          colno: event.colno,
          stack: event.error?.stack,
          error: event.error,
        });

        if (
          event.error &&
          event.error.message &&
          event.error.message.includes("Unexpected token")
        ) {
          console.error(
            "JSON parsing error detected - this usually means a resource returned HTML instead of expected JSON/JS"
          );
        }
      });

      window.addEventListener("unhandledrejection", function (event) {
        console.error("Unhandled promise rejection:", {
          reason: event.reason,
          promise: event.promise,
        });

        if (
          event.reason &&
          event.reason.message &&
          event.reason.message.includes("Unexpected token")
        ) {
          console.error(
            "JSON parsing error in promise - check network tab for failed requests"
          );
        }
      });

      // Initialize with delay to avoid conflicts
      setTimeout(() => {
        console.log("WaveRoll Demo initialized");
        console.log("Player components available:", isPlayerAvailable());

        // Load player components
        initializePlayer();
      }, 100);
    </script>

    <!-- Strip emojis from all text nodes dynamically -->
    <script>
      (function () {
        const removeEmoji = (str) =>
          str.replace(/\p{Extended_Pictographic}/gu, "");

        const stripNode = (node) => {
          if (node.nodeType === Node.TEXT_NODE) {
            node.textContent = removeEmoji(node.textContent);
          } else {
            node.childNodes.forEach(stripNode);
          }
        };

        // Initial pass
        stripNode(document.body);

        // Observe future changes
        const observer = new MutationObserver((mutations) => {
          mutations.forEach((mutation) => {
            mutation.addedNodes.forEach(stripNode);
          });
        });

        observer.observe(document.body, { childList: true, subtree: true });
      })();
    </script>
  </body>
</html>
